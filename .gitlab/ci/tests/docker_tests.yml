stages:
  - test

image:
  name: docker/compose:latest

services:
  - docker:dind

before_script:
  - docker version
  - docker-compose version
  - docker-compose -f test.docker-compose.yaml build

tests:
  stage: test
  artifacts:
    when: on_failure
    paths:
      - tests/e2e/test-results/**/*.webm
    expire_in: 1 day
  script:
    - docker-compose -f test.docker-compose.yaml up -d keycloak database
    - sleep 60
    - docker-compose -f test.docker-compose.yaml up -d proxy handler
    - sleep 10
    - docker-compose -f test.docker-compose.yaml run --name e2e-ci e2e-tests
  after_script:
    - docker cp e2e-ci:/e2e/test-results/ $CI_PROJECT_DIR/tests/e2e/ || true
    - docker-compose -f test.docker-compose.yaml down
