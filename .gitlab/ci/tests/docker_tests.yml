stages:
  - test

image:
  name: docker/compose:latest

services:
  - docker:dind

before_script:
  - docker version
  - docker-compose version
  - docker-compose build

tests:
  stage: test
  artifacts:
    when: always
    paths:
      - tests/e2e/test-results/**/*.webm
    expire_in: 1 day
  script:
    - docker-compose up -d keycloak database
    - sleep 60
    - docker-compose up -d proxy handler
    - sleep 60
    - docker-compose up --exit-code-from e2e-tests
  after_script:
    - docker cp e2e-tests:/e2e/test-results/ $CI_PROJECT_DIR/tests/e2e/
    - docker-compose down
